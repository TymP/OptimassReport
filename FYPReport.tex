\documentclass{report}
\author{Tymon Pakulski\\Department of Mechanical Engineering, University of Bath\\In Collaboration with CERN - The European Organization for Nuclear Research \\\\ Supervised by Dr. Roger Ngwompo\\Assessed by Dr. Martin Ansell}
\title{Experimental Assessment of a Krohne Optimass 6400 Mass Flow Meter for Determining CO$_2$ Vapour Quality}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage[top=2.5cm, bottom=2.5cm, left=3cm, right=1cm]{geometry}
\usepackage{gensymb}
\usepackage{placeins}
\usepackage{pdflscape}
\usepackage{pdfpages}
\usepackage[toc,page]{appendix}
\usepackage{subcaption}                                            
\usepackage{titlesec}   
\usepackage{titling}
\usepackage{acronym}
\usepackage{caption}
\usepackage{hyperref}
\hypersetup{%
    pdfborder = {0 0 0}
}
\usepackage{float}
\usepackage{wrapfig}
\usepackage{setspace}
\usepackage{multirow}
\newcommand{\squeezeup}{\vspace{-2.5mm}}
\restylefloat{figure}
\newcommand{\subtitle}[1]{%
  \posttitle{%
    \par\end{center}
    \begin{center}\Large#1\end{center}
    \vskip0.5em}%
}                                           
\titleformat{\chapter}{\normalfont\huge}{\thechapter.}{20pt}{\huge}

\subtitle{Final Year Project Report}
%GUIDELINES: Margins: 30mm LHS, 10mm RHS, 25 mm top and bottom. Double spaced, single sided.
\begin{document}
\graphicspath{{figures/}}
\includepdf[pages={1}]{docs/bathCoverPage.pdf}
\maketitle
\begin{abstract}
\pagenumbering{roman}
%Mention findings from lit reveiew
\end{abstract}
\section*{Acknowledgments}
Thanks to Dr. Roger Ngwompo, my academic supervisor, and Dr. Martin Ansell, FYP coordinator, for making my continued collaboration with CERN possible. I'd also like to thank Nicola Spadavecchia, Bart Verlaat and Jerome Noel for their technical support. Finally, my thanks to Paola Tropea, my industrial supervisor, for her sharp questions and crucial guidance throughout my research. 
\newpage
\section*{Terms and Acronyms}
\begin{acronym}
\acro{CERN}{The European Oranization for Nuclear Research} 
\acro{Nikhef}{National Institute for Subatomic Physics, Amserdam, Netherlands}
\acro{HEP}{High-Energy Physics}
\acro{CMS}{Compact Muon Solenoid - a CERN experiment} 
\acro{LHC}{Large Hadron Collider}
\acro{2PACL}{Two-phase accumulator control loop}
\acro{LS1}{Long Shutdown One - A planned shutdown of the LHC between February 2013 and April 2015 for maintenance and upgrade.}
\acro{CFCs}{Chlorofluorocarbons} 
\acro{Tracker}{Type of particle detector that tracks the paths of charged particles.} 
\acro{TIF}{Tracker Integration Facility}
\acro{PH-DT}{CERN Physics Department, Detector Technologies Group}
\acro{EGM}{Entrained Gas Management}
\acro{DAQ}{Data Acquisition}
\acro{SCADA}{Supervisory Control and Data Acquisition - A remote control and data acquisition system facilitating communication between a user and a PLC with a graphical user interface.}
\acro{PWM}{Pulse Width Modulation}
\acro{R744}{Refrigerant Code for CO$_2$}
\acro{Sub-cooling}{The difference between a fluids saturation temperature and current temperature. i.e. the temperature increase required to begin phase transition.}
\acro{Interaction Point}{The point in a particle detector where the two particle beams collide, releasing radiation in all directions.}
\acro{.csv}{Comma-Seperated Value}
\acro{$C_6F_{14}$}{Perflourohexane, a common industrial refrigerant and electrical insulator.}
\end{acronym}
\section*{Symbols}
\begin{tabular}{|c c c|}
\hline
\textbf{Symbol} & \textbf{Property} & \textbf{Default Unit} \\\hline
H & Enthalpy & J \\
X & Vapour Quality & \% \\
T & Temperature & $^\circ$C\\
$\dot{m}$ & Mass Flow Rate & kgs$^{-1}$ \\
P & Pressure & bar abs \\
V & Volume & m$^3$ \\
$\dot{V}$ & Volumetric Flow Rate & m$^3$s$^{-1}$\\
$\dot{Q}$ & Heat Load & Watts \\
$\phi$ & Void Fraction & \% \\\hline
\end{tabular}
\begin{tabular}{|c c c|}
\hline
\textbf{Symbol} & \textbf{Property} & \textbf{Default Unit} \\\hline
G & Mass Flux & kgs$^{-1}$m$^{-2}$\\
A & Cross-Sectional Area & m$^2$\\
I & Current & Amperes \\
V & Voltage & Volts \\
p & Power & Watts \\
$\rho$ & Density & kgm$^{-3}$\\
v & velocity &  ms$^{-1}$\\
VPV & Vapour Phase Velocity & ms$^{-1}$\\
P$_R$ &Reduced Pressure & -\\\hline
\end{tabular}
\tableofcontents
\chapter{Introduction}
\pagenumbering{arabic}
\doublespacing
CERN's PH-DT group is undertaking extensive R\&\ignorespaces D in the domain of evaporative CO$_2$ cooling for particle detectors. A crucial parameter in the design and commissioning of these systems is vapour quality - the mass fraction of fluid that is vapour. Krohne, a supplier of instrumentation for the process industry, has approached CERN with a new instrument, the Optimass 6400 coriolis mass flow meter. This instrument is theoretically capable of measuring mass flow rate, density and temperature of 2-phase flow - a major breakthrough  in the field. The new technology, if it performs well enough, could be used to determine vapour quality using a measurement of 2-phase density. \\
By measuring the accuracy of the instrument across a range of 2-phase conditions, this study sought to evaluate its practicality for determining vapour quality in CO$_2$ cooling systems - a capability that would be directly useful in the coming decade of CO$_2$ cooling R\&\ignorespaces D. The research combined experimental testing of the sensor with a combined theoretical-computational approach to calculate reference conditions.
\FloatBarrier
\section{CO\texorpdfstring{$_2$}{TEXT} Cooling at CERN}
CERN's various particle detectors require cooling to manage the heat load of the detector electronics, radiation from the interaction point and heat leak from the ambient environment. Evaporative CO$_2$ cooling has become the predominant candidate technology for future particle trackers in HEP.\cite{mishra} CO$_2$'s combination of thermodynamic properties and radiation hardness make it ideal for HEP applications - it can be used in highly radioactive areas and is considered environmentally friendly. In addition, it cools efficiently in small-diameter tubes, minimising the material budget - a crucial metric representing the amount of non-instrumentation material inside the particle detector. \cite{jerome} \\The current $C_6F_{14}$ cooling system for the pixel detector, the innermost layer of the CMS tracker, is  being replaced with a CO$_2$ system and a transition to this technology is foreseen for the entire CMS tracker by the year 2025.
\FloatBarrier
\begin{figure}
\centering
\includegraphics[width=0.8\textwidth]{figures/CMS.jpg}
\caption{A diagram of the CMS particle detector on the LHC. \cite{mishra}}
\label{fig: cms}
\end{figure}	
\FloatBarrier
\section{2-Phase Accumulator Controlled Loop}
\FloatBarrier
The CO$_2$ systems at CERN implement the 2PACL design. \cite{TIF PoS}\cite{bart}. This involves pumping liquid coolant into the detector, where it is expanded and cools its surroundings by partially evaporating. After cooling the detector with the latent heat of vaporisation, the mix of liquid and vapour returns to the plant by way of a condenser, which returns it to pure liquid for pumping. An accumulator filled with 2-phase fluid sits on the return line of the circuit, its pressure determining the position of the coolant temperature (and pressure; the fluid is 2-phase), and therefore the position of the cooling cycle on the P-h diagram. Accumulator pressure is regulated using an array of heaters and a heat exchanger with an independent chiller circuit that also cools the condenser. The cycle and a schematic of the 2PACL concept are shown in figure \ref{fig:2PACL}.
\begin{figure}[h]
\includegraphics{2PACLschem}
\caption{A schematic of the 2PACL concept as implemented in Thermal Control System of the LHCb Velo project at CERN \cite{CO2 PoS}}
\label{fig:2PACL}
\end{figure}
\FloatBarrier
\section{Vapour Quality and 2-Phase Density}
\FloatBarrier
Vapour quality refers to the fraction of a fluid's mass that is in the vapour phase.
\begin{eqnarray}
X=\frac{m_{vapour}}{m_{fluid}}
\end{eqnarray}
In 2PACL cooling systems, the vapour quality after the coolant evaporates is an essential parameter indicating the amount of evaporation that has occurred. The quality determines how far from the coolant is from dry-out - a condition where the liquid fraction becomes so low that it begins to seperate from the pipe wall. Dry out implies a dramatic decrease in heat transfer coefficients, causing a sudden reduction in cooling that can damage the particle detector. A real-time calculation of vapour quality would allow the design of leaner cooling systems as dry out conditions can be observed before they occur, reducing the safety factors taken in sizing the liquid mass of the system.\\
\FloatBarrier
\begin{wrapfigure}{l}{0.5\textwidth}
\vspace{-1.5cm}
\begin{center}
\includegraphics[width=0.48\textwidth]{densityMethod.jpg}
\end{center}
\caption{Principle for determining vapour quality, \textit{X}, from two-phase density. Adapted from B. Verlaat. \cite{CERN courier}}
\label{fig:densityMethod}
\end{wrapfigure}
\FloatBarrier
Vapour quality at any point on a P-h diagram can be determined using the lever rule inside the vapour dome, as shown in Figure \ref{fig:densityMethod}. The quality is given by ratio of the distance to the liquid phase to the width of the entire dome. But in 2PACL, it is challenging to precisely locate the fluid's state in the vapour dome. \\
While in pure liquid any point on the P-h diagram can be determined from pressure and temperature, during phase transition these values are saturated, and therefore a third variable is needed. One obvious choice is density, as shown in Figure \ref{fig:densityMethod}. With the local pressure and density, the fluid's exact location in the vapour dome, and therefore its vapour quality, can be determined. This is the fundamental principle for determining vapour quality using the Optimass 6400 instrument.

\FloatBarrier
\section{The Krohne Optimass 6400}
The Optimass 6400 is a new twin bent tube coriolis mass flow meter. It features 3 independent measurements, from which it calculates 7 output signals. The 3 fundamental measurements to be assessed are:
\begin{itemize}
\item{Mass Flow Rate - Coriolis principle.}
\item{Density - Natural frequency of an oscillating tube.}
\item{Temperature - Internal probe.}
\end{itemize}
\begin{wrapfigure}{r}{0.3\textwidth}
\vspace{-4cm}
\begin{center}
\includegraphics[width=0.28\textwidth]{Optimass6400}
\end{center}
\caption{The Krohne Optimass 6400 mass flow meter.} %cite KROHNE DATA SHEET}
\label{fig:optimass6400}
\end{wrapfigure}
\FloatBarrier
The instrument is unique because of its Entrained Gas Management - it is able to continue reading mass flow, density and temperature of 2-phase flow. \cite{processArticle} The instrument's accuracy has been measured using liquid water with entrained air bubbles, but never with a single fluid in two phases. 
\section{Objectives and Documentation}
\FloatBarrier
This study sought an overview of the Optimass 6400's steady-state measurement accuracy over a wide operating envelope, and the implications of this accuracy for vapour quality measurement. Specific objectives are given below:
\begin{itemize}
\item{Compare mass flow and density readings with reference instrumentation and theory over a range of temperatures and vapour qualities.}
\item{Quantify the instrument's steady-state performance and, if possible, identify an effective performance envelope.}
\item{Express the instrument's accuracy in terms of vapour quality.}
\item{Validate the theory of determining vapour quality using 2-phase density and local pressure.}
\item{Investigate the physical phenomena behind any performance trends.}
\item{Identify areas for further research.}
\end{itemize}
The instrument was tested over the following ranges:
\begin{itemize}
\item{Coolant Temperature: -25 - +5 $^\circ$C}
\item{Nominal mass flow rate: 20 - 105 gs$^{-1}$.}
\item{Vapour Quality 0 - 70\% using an available heat load of 0-13 kW}
\end{itemize}
Background to the problem and relevant literature are summarised in Chapter \ref{litReview}. Chapter \ref{methods} describes the method employed to test and analyse the sensor's performance, and the results of the testing are presented in Chapter \ref{results}. Finally, speculation as to the cause of performance trends revealed in Chapter \ref{results} and areas for further research are documented in chaters \ref{discussion} and \ref{further research}. Key pieces of MATLAB code are available in Appendix \ref{app:Matlab}, and the entire repository including raw data is available online at \textit{www.github.com/TymP/OptimassMATLAB} .


\chapter{Literature Review} \label{litReview}
\addtocontents{toc}{\protect\setcounter{tocdepth}{0}}
\FloatBarrier
\vspace{-1cm}
\section{Behaviour of 2-Phase CO$_2$} \label{behaviour}
As a coolant, CO$_2$ is new and different from conventional refrigerants, and its characteristics are generally difficult to predict. Research so far has characterised its performance in terms of heat transfer coefficients in convection and boiling, pressure drops and flow pattern.\cite{Mastrullo 2010}\cite{Cheng 2008}\cite{Yun 2005}\cite{Wu 2011} These phenomena are documented with respect to vapour quality, because this convenient parameter takes into account mass flow rate and heat flux, simplifying data visualisation. \\
The most relevant data to this study concerns flow patterns. As a flowing coolant evaporates, the interactions between its liquid and vapour phases manifest themselves in complex ways. As vapour quality increases, the two phases' velocities diverge. Because liquid is far denser than vapour, the vapour phase requires a higher volumetric flow rate - known as the superficial phase flow rate - to achieve the mass flow rate stipulated by the vapour quality. \\
\begin{eqnarray}
X=\frac{\dot{m}_{vap}}{\dot{m}_{fluid}}\\
\dot{V}_{vap}\rho_{vap}=X\dot{m}_{fluid}\\
VPV[ms^{-1}]=\frac{\dot{m}X}{\rho_{vap}A}
\end{eqnarray}
This phenomenon is a major factor in the creation of flow patterns - geometric configurations of 2-phase flow that are influenced by vapour quality, mass flux - a function of mass flow rate and pipe geometry - and the presence of swirl or turbulence. Some of these are summarised in Figure \ref{fig:flowPatterns}. 
\FloatBarrier
The boundaries between flow patterns are typically documented by plotting mass flux against vapour quality, giving a so-called flow pattern map. Cheng et al. published prehaps the most widely-cited flow pattern map for CO$_2$. \cite{Cheng 2008}. The map, shown in Figure \ref{fig:chengMap}, is valid for tube diameters between 0.6 and 10 mm, and mass fluxes between 50 and 1500 kgm$^{-2}$s$^{-1}$, making it relevant to the present study.\\
\begin{wrapfigure}{r}{0.5\textwidth}
        \centering
        \begin{subfigure}[b]{0.5\textwidth}
                \includegraphics[width=\textwidth]{flowPatterns}
                \caption{A summary of liquid-vapour flow patterns. \cite{MIT}}
  				\label{fig:flowPatterns}
        \end{subfigure}%
         %add desired spacing between images, e. g. ~, \quad, \qquad, \hfill etc.
          %(or a blank line to force the subfigure onto a new line)
          \\
        \begin{subfigure}[b]{0.5\textwidth}
                \includegraphics[width=\textwidth]{chengMap}
                \caption{The updated flow pattern map for CO$_2$ developed by Cheng et al. \cite{Cheng 2008}}
  				\label{fig:chengMap}
        \end{subfigure}
		\caption{Flow patterns in liquid-vapour flow.}
\end{wrapfigure}
%\begin{wrapfigure}{R}{0.5\textwidth}
%\begin{center}
%\includegraphics[width=0.48\textwidth]{flowPatterns}
%\end{center}
%\caption{A summary of liquid-vapour flow patterns. \cite{MIT}}
%\label{fig:flowPatterns}
%\end{wrapfigure}
%\begin{wrapfigure}{R}{0.6\textwidth}
%\begin{center}
%\includegraphics[width=0.48\textwidth]{flowPatterns}
%\includegraphics[width=0.58\textwidth]{chengMap}
%\end{center}
%\caption{The updated flow pattern map for CO$_2$ developed by Cheng et al. \cite{Cheng 2008}}
%\label{fig:chengMap}
%\end{wrapfigure}
While the boundaries between flow regimes are frequently updated with new data, the general pattern of CO$_2$ cooling performance as it evaporates has remained consistent. A broad spectrum of literature summarised in a review by Mastrullo et al.\cite{Mastrullo 2010} observes the flow transitioning from single-phase to some form of intermittent flow, then to a broad region of annular flow, and finally to dry out, where it exhibits a dramatic decrease in HTC and thus in cooling efficiency. If the coolant continues to be heated, it reaches mist flow, and its cooling performance continues to plummet. 
\\
One more important phenomenon to consider is \textit{Reduced Pressure}. Reduced pressure is defined as the ratio of working pressure to critical pressure:
\begin{eqnarray}
P_R=\frac{P}{P_{crit}}
\end{eqnarray}
Research into this phenomenon is in its infancy. But for now it can be safely said that the further a coolant operates from its critical pressure - the lower its $P_R$, the less predictable its behaviour is with existing theory. \cite{Mastrullo 2012}\cite{Mastrullo 2012b} Research shows that a low $P_R$ affects the physics of boiling, making phenomena like HTC and evaporation behaviour difficult to predict.
\FloatBarrier
\section{Determining Vapour Quality}
Literature on direct measurement of vapour quality is scarce, especially for CO$_2$. B.R. Jean presented a steam quality sensor that employs microwaves, yielding an accuracy of 2.8\%. \cite{Jean 2007}. The operating principle relied on the dielectric properties of water. A review of steam quality measurement approaches conducted by Dorman and Fridman \cite{Dorfman 2006} evaluated calorimeter, chemical tracer and flow seperation methods, revealing their significant drawbacks. The authors then presented a new theoretical method for measuring vapour fraction, but it was limited to fluid in a static container. \\
Void fraction, defined as the volumetric fraction of fluid in the vapour phase, is an intuitive candidate for an inderect measurement of vapour quality. 
\begin{eqnarray}
\phi =\frac{V_{vapour}}{V_{fluid}}
\end{eqnarray}\\
Indeed, several methods have been developed for the measurement of void fraction, relying on capacitance measurement \cite{Beker 2005}, x-rays \cite{Bauer 2012}, electron sources \cite{Augyrond 2001} and gamma ray densiometers \cite{Zhao 2013}. However, the conversion of void fraction to vapour quality is far from straightforward, as the mass fraction of vapour depends on the density of both the vapour and the fluid:
\begin{eqnarray}
X =\phi\frac{\rho_{vapour}}{\rho_{fluid}}
\end{eqnarray}
Empirical relations have been developed, most notably by Zuber and Findaly, between void fraction and vapour quality, but their complexity and limited range makes them impractical for a real-time application.\cite{lecture}\\
As mentioned in Section \ref{behaviour}, vapour quality is a common parameter across combinations of mass and heat flux, and it is therefore favoured by researchers in the characterisation of CO$_2$. Research of flow patterns, heat transfer coefficients and 2-phase pressure drops employs vapour quality as a key variable for the visiualisation of data. \cite{Cheng 2008}\cite{Mastrullo 2009a}\\
Because the direct measurement of vapour quality is not practical, these researchers have relied on analytically determining vapour quality from test conditions. Most have evaluated the enthalpy of the fluid in a sub-cooled liquid state, before applying a measured heat load. Given the heat load and the mass flow rate, they are able to calculate the corresponding change in enthalpy, giving the 2-phase enthalpy and therefore the vapour quality. \cite{Mastrullo 2009c} \cite{Wu 2011} \cite{Yun 2005} Details of this approach are given in Chapter \ref{methods}.
\section{2-Phase Performance of Coriolis Flow Meters}
\FloatBarrier
Coriolis flow meters work by inducing a phase shift in the forced oscillations of two bent tubes using the Coriolis principle. A schematic of the principle is given in Figure \ref{fig:coriolis}. As the tubes vibrate at their natural frequency, the velocity of the flow as it is directed radially toward and away from the axis of oscillation induces a phase shift varying linearly with the mass flow rate of the fluid through the instrument. \cite{ISO}\cite{O'Banion 2013}  \\
\begin{figure}[h]
\centering
\includegraphics[width=0.58\textwidth]{coriolis}
\caption{The working principle of coriolis flow meters. \cite{coriolisPrinciple}}
\label{fig:coriolis}
\end{figure}
\FloatBarrier
Density, when independently measured in coriolis flow meters, is typically determined from the resonant frequency of the bent tubes. \cite{ISO}\cite{O'Banion 2013} The frequency is a function of the tube stiffness and mass. So any change in frequency reflects a change in the mass of the fluid inside the tube. The sensor corrects for temperature effects on stiffness and then, with a known tube volume, determines the density. \cite{ISO}\\
Both of these measurement principles can be severely disrupted by 2-phase flow. Entrained gas may create slip planes between the phases, which cause unpredictable forces and vibrations.\cite{ISO}\cite{processArticle}\cite{emerson2Phase} This leads to two problems in instrumentation: first, the unexpected vibrations disturb sensitive electronics. Second, the slip between the phases dampens forced vibrations, possibly stopping the sensor from oscillating altogether. In a typical coriolis flow meter the first symptom of entrained gas is the drive gain, the power required oscillate the tubes, rising to 100\%. \cite{ISO}\cite{emerson youtube}\\
Because of the implications of entrained gas, some manufacturers of process instrumentation have developed products to detect it. The Emerson Rosemount 3051S Pressure Transmitter, for example, employs statistical methods to detect characteristic frequencies of entrained gas. \cite{emerson EGM} However, until now, the Optimass 6400 is the first coriolis flow meter that is claimed to function effectively with 2-phase flow.
\\
Because both the mass and density measurements in coriolis flow meters rely on macroscopic properties of the fluid - flow velocity and aggregate density, intermittent flow intuitively seems the most problematic. It can be imagined that a pulse of high-velocity gas between liquid phases could disrupt sensitive electronics. Indeed, the ISO standard for coriolis meters indicates that they can be used without problems in pure gas flow, as well as in homogeneous 2-phase mixtures - an annular flow pattern, for example. \cite{ISO} The obscure industrial research on this topic confirms this trend, with manufacturers stating that annular flow patterns can be measured accurately. \cite{emerson2Phase}\\
What makes the Optimass 6400 unique is its Entrained Gas Management technology. The meter itself is a copy of the older Optimass 6000, but innovations in the MFC 400 signal converter that it interfaces with set it apart. These electronics employ advanced signal processing and a completely digital drive signal to allow the instrument to continue measuring in 2-phase flow. \cite{krohne brochure}\cite{processArticle}\\
\addtocontents{toc}{\protect\setcounter{tocdepth}{1}}

\chapter{Methods} 
\label{methods}
\vspace{-1cm}
\section{Experimental Methods}
\FloatBarrier
Laboratory research was carried out using the future CMS pixel detector cooling system located in the Tracker Integration Facility clean room at CERN, pictured in Figure \ref{fig:TIF}. This cooling system, hereafter referred to as TIF, employs the 2PACL concept for evaporative CO$_2$ cooling. It allows control of the coolant temperature, its flow rate and the heat load applied to  it. \\
\begin{figure}[h]
\includegraphics[width=\textwidth]{TIFandHeater.jpg}
\caption{The TIF cooling plant[L] and dummy load heater [R]. \cite{tif web}}
\label{fig:TIF}
\end{figure}
TIF consists of a membrane pump routing liquid CO$_2$ through a concentric transfer line to a manifold where the flow is split and can be heated. \textit{Dummy Load} heaters represent the detector heat load, evaporating the CO$_2$ in the manifold. An accumulator containing 2-phase fluid on the return line of the manifold regulates the pressure set point using an array of heaters and a heat exchanger. A chiller circuit cools the accumulator and the condenser at the pump inlet.\\
A full Process and Instrumenation Diagram is given in Appendix \ref{app:TIF}.

\FloatBarrier
\subsection{Apparatus}
The TIF cooling system services eight cooling loops in the manifold and includes several bypasses, heaters and instrumentation that are mostly relevant to the  start-up procedure. These are configured using a series of pneumatic, manual and electro-mechanical valves. 
The plant was configured the same way for all tests: with all bypass loops closed, and a single loop, number 7424, open in the manifold. This configuration ensured all fluid leaving the plant passed through this loop and through the Optimass instrument, and allows the experimental apparatus to be represented by a simplified P \& I diagram given in Figure \ref{fig:TIfsimplified}.\\
\FloatBarrier
\begin{figure}[h]
\includegraphics[width=\textwidth]{TIFsimplified.jpg}
\caption{A simplified process and instrumentation diagram of the TIF cooling plant in the configuration relevant to the tests, displaying only relevant instrumentation. A diagram of the whole TIF if given in appendix \ref{app:TIF}}
\label{fig:TIfsimplified}
\end{figure}
\FloatBarrier
The Optimass instrument was mounted on a test stand close to the TIF manifold, as shown in figure \ref{fig:sensor}. Following guidance from Krohne, it was mounted upside-down, with the MFC 400 signal converter closer to the floor. The instrument's discharge was connected through a flexible pipe to the the return lines of loop 7424 in the \textit{TIF} manifold. On the supply side, the instrument was connected directly to the discharge of the heating section. \\
\FloatBarrier
\begin{wrapfigure}{R}{0.6\textwidth}
        \centering
        \begin{subfigure}[b]{0.28\textwidth}
                \includegraphics[width=\textwidth]{sensor}
                \caption{Front view.}
  				\label{fig:sensor}
        \end{subfigure}%
        ~
        \begin{subfigure}[b]{0.28\textwidth}
                \includegraphics[width=\textwidth]{heaterCloseUp}
                \caption{Side view.}
  				\label{fig:heaters}
        \end{subfigure}
        ~ %add desired spacing between images, e. g. ~, \quad, \qquad, \hfill etc.
          %(or a blank line to force the subfigure onto a new line)
          \caption{Photographs of the Optimass sensor connected to the dummy load heating section. The direction of flow is given by the blue arrows.}
\end{wrapfigure}
\FloatBarrier
The heating section of loop 7424 consists of a 35 mm OD vertical pipe welded to two tee unions. Two cartridge heater inside 22 mm pipes are axially inserted into the pipe through the tee fittings, as shown in figure \ref{fig:heaters} and in the drawing in Appendix \ref{app:DummyLoad}. The flow enters the heating section radially with respect to the heaters through the lower tee union. It is forced into an anuular shape encircling the heater, and flows upward to the discharge tee-union. It then enters a short unobstructed series of circular fittings before reaching the Optimass instrument. \\
The vacuum-insulated instrument and all exposed pipes were covered with a 20 mm layer of \textit{Armaflex} insulation to mitigate heat pick-up. All fittings were leak tested at 50 bar gas using a CO$_2$ sniffer prior to testing, and the instrument's position and inlet conditions respected the guidelines given in the sensor documentation \cite{krohne online}, as well as input from Krohne engineers. 
\FloatBarrier
\subsection{Control and Data Acquisition}
All of the instrumentation on the TIF plant, the dummy load and the Optimass flow meter is cabled to a central PLC in the TIF clean room. Each instrument communicates a 4-20 mA analogue signal, which is mapped by the PLC to produce a value in the correct units. All of the data is continuously recorded - day and night - but logged to a server only when one of the signals changes. This produces a low sampling rate at stable conditions, but several Hz during transient conditions - meaning hundreds of thousands of data points over the 3-week test campaign.
The Optimass sensor was configured by Krohne to deliver mass flow, density and temperature as 4-20 mA signals in the following measurement ranges:\\
\begin{itemize}
\item{Mass Flow Rate: 1.4-115 gs$^{-1}$} 
\item{Density: 100.6 - 1100 kgm$^{-3}$}
\item{Temperature: -40 - +40 $^\circ$C}
\end{itemize}
The sensor was cabled to the same PLC controlling TIF and logging all of its instrumentation, and the signals were mapped to the values configured by Krohne. This approach streamlined control and data export by consolidating the plant, heaters and instrument on a single SCADA interface, and logging the data in a single location at common timesteps. 
\subsection{Key Variables}
The instrument's performance was to be assessed in relation to three independent variables:
\begin{itemize}
\item{Coolant temperature - regulated by the accumulator set point.}
\item{Mass flow rate - set by the pump speed and stroke.} 
\item{Heat Load - set by the heaters' rms current.}
\end{itemize}
The coolant temperature set point determines the position along the vapour dome on a P-h diagram of the 2PACL cycle, and therefore the local pressure in the instrument. This influences the evaporative behaviour of the coolant, as well as the vapour quality for a given density. While a wide range of temperature was to be explored, the invariance of the temperature during a tests was an essential control variable. \\
The mass flow rate was set by the speed and stroke of the pump, but not regulated during tests. This meant that as the vapour quality of the coolant increased, the resulting increase in pressure drop decreased the effective flow rate for given pump conditions. The resulting fluctuations in true flow rate affect the trends plotted by nominal flow rate, but because flow rate is measured in real time, they did not effect error signal calculations.\\
The dummy load heaters are resistive cartridge heaters, whose power is controlled by pulse width modulation. User-requested Watt values on the SCADA interface, are interpreted by the PLC to apply the correct PWM signal to achieve the demand power. 
\\
A broad range of all three variables was explored. But because this experiment sought only to evaluate steady-state performance, transient data was to be minimised. The control variables were therefore closely monitored to minimise fluctuations. 
\subsection{Test Protocol}
\FloatBarrier
Before beginning 2-phase testing, the instrument's calibration was validated in pure liquid by comparing its readings of mass flow, density and temperature with a reference instrument on the plant (FT3020) for a range of flow rates and temperatures.\\
For 2-phase testing, a test protocol was developed to ensure consistency of data. A change to any of the independent variables caused a significant transient response. But the process of fine-tuning the values and waiting for their response to settle differed for each variable, as shown in Table \ref{tab:settle}. Tests were designed accordingly.\\\FloatBarrier
\begin{table}[h]
\centering
\begin{tabular}{|l|l|l|l|}
\hline
\multicolumn{3}{ |c| }{\textbf{Key Variables and Settling Times}} \\\hline
\textbf{Variable} & \textbf{Control Method} & \textbf{Settling Time}\\\hline
Temperature & Accumulator Set Point & 30-90 minutes\\\hline
Mass Flow Rate & Pump speed and stroke & 15-30 minutes\\\hline
Vapour Quality & Dummy Load Power & 5-15 minutes\\\hline
\end{tabular}
\caption{Key variables, their control method and their settling times.}
\label{tab:settle}
\end{table}
\FloatBarrier
Altering test conditions employed a nested approach. First, the coolant temperature was set in the accumulator. Then various heat loads were applied at a given pump speed to explore a range of vapour qualities at a given flow rate, before changing the pump conditions. A typical test segment: various heat loads at a given flow rate and temperature, is shown in Figure \ref{fig:typicalTest}. 
\FloatBarrier
\begin{figure}
\includegraphics[width=\textwidth]{typicalTestEdited}
\caption{A typical test. The steps in heat load are shown as vertical red lines.}
\label{fig:typicalTest}
\end{figure}
After observing steady state conditions, the timestamp for these conditions was logged in an Excel file and the plant allowed to continue running for one minute, before changing the test conditions again. This ensures a span of one minute of steady-steady state data which could later be time-averaged to elimenate sensor noise.
\FloatBarrier
\section{Data Analysis Methods} \label{analysis}
A method, summarised in Figure \ref{fig:processing}, was devised for the export, pre-processing and process of data. This approach filtered through the hundreds of thousands of data points to reach a small subset of steady-state data during test conditions. \\
\FloatBarrier
\begin{figure}[h]
\includegraphics[width=\textwidth]{processing}
\caption{A summary of data processing and analysis.}
\label{fig:processing}
\end{figure}
\FloatBarrier
\subsection{Assumptions}
The experiment and subsequent analysis rested on a series of assumptions at steady-state conditions, including:
\begin{enumerate}
\item{Flow is fully liquid at the manifold inlet to allow calculation of inlet enthalpy - h$_3$ - from the inlet pressure and temperature.}
\item{All thermodynamic processes outside the dummy load heating section are adiabatic. Heat pick up in the insulated manifold, vacuum insulated instrument and Armaflex-insulated flexible pipes is negligible relative to the heat load being applied by the dummy load.}
\item{All power provided by the heaters is a power input to the coolant. In steady-state conditions the entire thermal apparatus: heaters, surrounding air and piping, and fluid directly in contact are in thermal equilibrium.}
\item{The open-loop-controlled heaters deliver the exact power requested by the user.}
\item{The accumulator set point temperature, and therefore the coolant temperature, are constant at the desired set point.}
\item{Physical inlet geometry is satisfactory for the effective functioning of the instrument. Potential effects like inlet swirl and turbulence are assumed negligible, despite the sudden change in inlet geometry.}
\item{Nominal flow rate set by the pump speed and stroke is constant.}
\end{enumerate}
\subsection{Export and Pre-Processing} %database management, steady-state filtering
Including time, 12 signals out of the many logged by the PLC were identified as being key for this study. These are summarised in table \ref{tab:keySignals}.\\
\FloatBarrier
\begin{center}
\begin{table}[h]
\begin{tabular}{ |c|c|c|l| }
\hline
\multicolumn{4}{ |c| }{\textbf{Key Signals}}\\\hline
\textbf{Signal Type} & \textbf{Signal Name} & \textbf{Thermodynamic Symbol} & \textbf{Description} \\\hline
Optimass & FT7524 & $\dot{m}$ & Mass flow rate measured by Optimass 6400\\\hline
Optimass & DT7424 & $\rho_5$ & Density measured by Optimass 6400 \\\hline
Optimass & TT7424 & T$_5$ & Temerature measured by Optimass 6400 \\\hline
Reference & FT3020 &  $\dot{m}_{ref}$ & Liquid mass flow rate measured in plant. \\\hline
Reference & PT7024 & P$_3$ & Manifold supply pressure. \\\hline
Reference & TT7024 & T$_3$ & Manifold supply temperature. \\\hline
Reference & EHDL1 & $\dot{Q}_a$ & Dummy load heater 1 power. \\\hline
Reference & EHDL2 & $\dot{Q}_b$ & Dummy load heater 2 power. \\\hline
Reference & PT7450 & $P_5'$ & Pressure at instrument discharge. \\\hline
\end{tabular}
\caption{Key Signals - Optimass signals refer to those measured by the instrument, reference signals to the surrounding instrumentation on TIF.}
\label{tab:keySignals} 
\end{table}
\end{center}
\FloatBarrier
A page of plots tracking these signals was created in the SCADA interface. Then, \textit{.csv} data for each signal was exported in four-hour test intervals. These \textit{.csv} files for each day of testing were then pre-processed using modified MATLAB scripts inherited from Bart Verlaat at Nikhef. These consolidated the tests into a single database - handling empty cells and overlapping timestamps, and saving the cleaned data in a new database to be called by MATLAB.
\subsection{Steady-State Filtering}
The raw database was filtered to plot analyse only steady state data. The architecture for this procedure combined the user-identified steady state timestamps with an algorithm measuring signal fluctuations going forward in time. While timestamps indicated nominally steady-state data for one minute, the imperfect method of a user identifying steady state conditions and deciding when to navigate to a new data point necessitated a more robust approach. \\Starting at the timestamp indicating steady state, the \textit{createTimeFilter3} script iterates through the indexes of all data vectors, calculating their current mean value, the mean of the next 3 indexes, and the deviation of the future value from the current one. If the deviation falls within allowable noise levels, the script continues collecting steady-state data. If the timestamps reach 30 seconds difference, the script terminates - 30 seconds is the maximum sample. At the end of each loop through a steady-state time stamps, all the steady state values are averaged into a single value representing the whole sample. The \textit{createTimeFilter3} script is given in Appendix \ref{app:Matlab} 
\subsection{Data Processing and Visualisation}
With the key signals filtered to leave only steady state conditions, these were processed to assess the sensor's performance. The sensor was evaluated using a combination of reference instrumentation, give in Table \ref{tab:keySignals}. Mass flow measurements were compared to a reference flow meter - FT3020 - while density and resulting vapour quality were compared with analytically computed reference conditions.\\
These calculations employed a theoretical MATLAB model to compute thermodynamic state variables in the sensor, and called a refrigerant modelling program called REFPROP to compute the local conditions of interest. 
Developed by National Instruments, REFPROP is the industry standard for calculating thermodynamic properties of refrigerants. \cite{REFPROP}
\subsection{Calculation of Reference Conditions}
\FloatBarrier

The reference density and vapour quality in the Optimass sensor were calculated using the local pressure and specific enthalpy with an analytical method common in the research discussed in Chapter \ref{litReview}. A pressure and an enthalpy give the fluid's exact location in the vapour dome, and the vapour quality and density can be read from the chart, as shown in Figure \ref{fig:enthalpyMethod}. \FloatBarrier
\begin{figure}
\centering
\includegraphics[width=0.5\textwidth]{enthalpyMethod.jpg}
\caption{The analytic model for calculating local 2-phase conditions at the flow meter.}
\label{fig:enthalpyMethod}
\end{figure}
\FloatBarrier
This was implemented using REFPROP. With the following syntax: \\\\
\textit{Q = refpropm('Q','P',$<P_5$ [kPa]$>$ , 'H', $<h_5$ [J/kg]$>$ , 'CO2')} \\\\
The local enthalpy at the sensor, \textit{$h_5$}, is given by the sum of the manifold inlet enthalpy, $h_3$ and the change in enthalpy due to the heat load, $\Delta$h.\\
\textit{$h_3$} was determined with REFPROP from the inlet manifold inlet conditions (Pressure and Temperature in pure liquid), while the change in enthalpy was calculated from the heat load and reference mass flow rate.\\\\
\textit{$h_3$=refpropm('H','P',$<P_3$ [kPa]$>$ ,'T', $<T_3$ [K]$>$, 'CO2')}\\\\
p = Heat Load [W]\\
\begin{eqnarray}
\Delta h=\frac{p}{\dot{m}}\\
h_5=h_3+\Delta h
\end{eqnarray}
\FloatBarrier
Since there is no reliable measure of pressure at the senor inlet, the local pressure is inferred from the saturation pressure at the temperature measured in the Optimass sensor: TT7424.
\subsection{Calculation of Mass Flux and Vapour Phase Velocity}
Mass flux defined as the mass flow rate per unit cross sectional area, is calculated in the MATLAB function \textit{findFlux()}, given in Appendix \ref{app:Matlab}.
\begin{eqnarray}
G [kgs^{-1}m^{-2}]=\frac{\dot{m}[kgs^{-1}]}{A[m^2]}
\end{eqnarray}
Where A, the cross-sectional area, is given by the area of the twin 8 mm ID circular tubes in the Optimass instrument.\\
The vapour phase velocity is a relevant parameter to flow meter performance, representing the linear velocity of the vapour phase in the pipe. The VPV depends both on the vapour quality  and the density of the vapour phase, which in turn varies with the saturation conditions.\\
Recalling equation \ref{eq:VPV}:
\begin{eqnarray}
X=\frac{\dot{m}_{vap}}{\dot{m}_{fluid}}\\
VSV[ms^{-1}]=\frac{\dot{m}X}{\rho_{vap}A} \\
\end{eqnarray}
The difficulty here is determining the vapour phase density from the aggregate density, but this was handled with REFPROP:\\
$\rho_{vap}$=refpropm('-','Q',$<$Vapour Quality$>$,T,$<$Saturation Temperature [$^\circ$C]$>$,'CO2');

\chapter{Results} \label{results}
\addtocontents{toc}{\protect\setcounter{tocdepth}{0}}
Because of the amount of raw data spread over weeks of testing and the focus of this study on steady-state conditions, the results presented below summarise the sensor's performance by examining measurement errors under various conditions. The key parameters have been defined as the relative flow rate and density measurement errors. Analytically calculated reference vapour quality has been adapted as a common parameter to plot performance against, as is common in the research discussed in Chapter \ref{litReview}.
\section{Overview}
\FloatBarrier
Figures \ref{plot:1} and \ref{plot:2} give an overview of the flow meter's performance in all the conditions tested by plotting relative flow and density errors across a range of vapour qualities. The mass flow errors are largely negative, their magnitude varying from 0-100\% and displaying a non-linear relation to vapour quality. The density errors also vary widely, but, for some conditions, their sign changes with vapour quality. The instrument appears to underestimate density in low vapour qualities, and overestimate it at high qualities.\\
\FloatBarrier
\begin{figure}
\includegraphics[width=\textwidth]{plots/fig1}
\caption{An overview of relative mass flow error against vapour quality.}
\label{plot:1}
\end{figure}
\begin{figure}
\includegraphics[width=\textwidth]{plots/fig2}
\caption{An overview of relative density error against vapour quality.}
\label{plot:2}
\end{figure}
\FloatBarrier
A cursory analysis of the errors implies that they are far from predictable, varying non-linearly with vapour quality. Further, the overall performance of the instrument across the range of vapour qualities appears to vary widely with temperature and nominal flow rate.\\
Despite the wide spread of data, the errors appear repeatable. While individual tests with identical nominal conditions have been lumped into common data series in Figure \ref{plot:1}, seperating them allows an assessment of repeatability. Figure \ref{plot:11} shows the relative measurement errors for four independent tests at the same temperature and nominal flow rate. 
\FloatBarrier
\begin{figure}[h]
\includegraphics[width=\textwidth]{plots/fig11}
\caption{Relative mass flow and density errors for various tests at 70 gs$^{-1}$ and -10$^\circ$C}
\label{plot:11}
\end{figure}
\FloatBarrier
Controlling for one of the test conditions refines the data, and reveals two interesting trends in the relative mass and density errors. They are discussed below.
\FloatBarrier
\section{Mass Flow Trend}
\FloatBarrier
Plotting the relative errors against vapour quality at a single temperature for various flow rates, as in figures \ref{plot:3} and \ref{plot:4}, reveals a clear relation between instrument performance and nominal flow rate. The trends in Figure \ref{plot:3}, which plots performance for various flow rates at -10$^\circ$C, show the absolute magnitude of the mass flow error across the entire range of vapour quality increasing with nominal mass flow rate. \\ \FloatBarrier
\begin{figure}
\includegraphics[width=\textwidth]{plots/fig3}
\caption{Relative mass flow error for several nominal flow rates at -10$^\circ$C.The method for these calculations is discussed in Section \ref{analysis}.}
\label{plot:3}
\end{figure}

\begin{figure}
\includegraphics[width=\textwidth]{plots/fig4}
\caption{Relative mass flow error for several nominal flow rates at -10$^\circ$C.}
\label{plot:4}
\end{figure}
\FloatBarrier
In addition, at higher nominal flow rates (50-105 gs$^{-1}$) the magnitude of the mass flow error appears to peak at certain vapour qualities before decaying. This peak tends toward dryer fluid (higher X) as nominal flow rate decreases. Both these relations: mean value of the mass flow error, and vapour quality at the peak error can not be immediately explained by the theory. However, two potential explanations are the flow pattern and the vapour phase velocity under these conditions. These two parameters have been calculated for the flow conditions at each of the peak mass flow errors, and are summarised in Table \ref{tab:flowConditions}. The density errors displayed in Figure \ref{plot:4} also demonstrate an improvement in sensor performance as the nominal flow rate decreases. But it appears the relation is more complex than for mass flow error. \\
Because flow rate is a first order factor of VPV, this velocity generally increases with nominal flow rate for a given vapour quality, as shown in Figure \ref{gasVelocity}.\\\\
\FloatBarrier
\begin{table}[h]
\centering
\begin{tabular}{|c|c|c|c|c|}
\hline
\multicolumn{5}{|c|}{\textbf{Flow conditions at peak mass flow errors for coolang at -10$^\circ$C}}\\\hline
Nominal Flow Rate & Vapour Quality & Mass Flux & Predicted Flow Pattern & Vapour Phase Velocity \\\hline
gs$^{-1}$ &  & kgm$^{-2}$s$^{-1}$ & & ms$^{-1}$\\\hline
50 &0.476 & 497 & Annular & 3.42 \\\hline
60 &0.485 & 597 & Annular & 3.93 \\\hline
70 &0.366 & 696 & Annular & 3.90 \\\hline
80 &0.346 & 796 & Annular & 3.91 \\\hline
90 &0.293 & 895 & Annular & 3.57 \\\hline
105 & 0.233 & 1037 & Annular & 3.44 \\\hline
\end{tabular}
\caption{Flow conditions at peak mass flow errors in \ref{plot:3}}
\label{tab:flowConditions}
\end{table}

\begin{figure}[h]
\includegraphics[width=\textwidth]{plots/fig12}
\caption{Velocity of the vapour phase against vapour quality for various mass flow rates.}
\label{gasVelocity}
\end{figure}

\FloatBarrier
\section{Temperature Trend}
%Temperature TREND***********************
A second trend is observable in the data when relative errors are plotted against vapour quality for a series of coolant temperatures at a single flow rate, as in figures \ref{plot:5}, \ref{plot:6}, \ref{plot:7} and \ref{plot:8}. The sensor's performance, both in mass flow and density measurements, generally improves as the coolant temperature increases.
\FloatBarrier
\begin{figure}
\includegraphics[width=\textwidth]{plots/fig5}
\caption{Relative mass flow error for several temperatures at 70 gs$^{-1}$ nominal flow rate.}
\label{plot:5}
\end{figure}

\begin{figure}
\includegraphics[width=\textwidth]{plots/fig6}
\caption{Relative density error for several temperatures at 70 gs$^{-1}$ nominal flow rate.}
\label{plot:6}
\end{figure}
\FloatBarrier
This trend is also visible at lower flow rates, albeit in a less pronounced way. The lower nominal flow rates already exhibit better overall performance  but, as shown in figures \ref{plot:7} and \ref{plot:8}, the gradient of their errors with respect to vapour quality decreases with coolant temperature.\\
As with the nominal mass flow rate relation, there is no immediate explanation for the temperature trend. It can be speculated that \textit{reduced pressure} plays a role. This possibility is discussed in Chapter \ref{discussion}. \FloatBarrier
\begin{figure}[h]
\includegraphics[width=\textwidth]{plots/fig7}
\caption{Relative mass flow error for several temperatures at 30 gs$^{-1}$ nominal flow rate.}
\label{plot:7}
\end{figure}

\begin{figure}
\includegraphics[width=\textwidth]{plots/fig8}
\caption{Relative mass flow error for several temperatures at 30 gs$^{-1}$ nominal flow rate.}
\label{plot:8}
\end{figure}
\FloatBarrier
\section{Vapour Quality Measurement at Low Flow Rates}
When expressed in terms of vapour quality measurement errors, the performance of the sensor is encouraging at low flow rates. At 30 gs$^{-1}$ and 20 gs$^{-1}$, summarised in figures \ref{plot:9} and \ref{plot:10}, the vapour quality error falls within 20\%, and decays with increasing reference vapour quality.
\begin{figure}
\includegraphics[width=\textwidth]{plots/fig9}
\caption{Relative vapour quality error against vapour quality for various temperatures at 30 gs$^{-1}$ nominal flow rate.}
\label{plot:9}
\end{figure}
%20 grams
\begin{figure}
\includegraphics[width=\textwidth]{plots/fig10}
\caption{Relative vapour quality error against vapour quality for -10$^\circ$C, 20 gs$^{-1}$ nominal flow rate.}
\label{plot:10}
\end{figure}
\FloatBarrier
\addtocontents{toc}{\protect\setcounter{tocdepth}{1}}
\chapter{Discussion} \label{discussion}
\vspace{-1cm}
\section{Overview}
The results reflect some of the intuitive expectations outlined in Chapter \ref{litReview}. While the Optimass 6400 succeeds in continuous measurement of 2-phase flow, its performance is unpredictable. Flow and density measurements are complex, and their accuracy seems to depend on temperature, vapour quality and mass flow rate with relations that cannot be readily consolidated into a single theory, given the current literature.\\
While the data is broadly spread, the test method has been validated by its repeatability, and data has been collected strategically to fulfill the original objectives: to evaluate a broad performance envelope, identify trends of interest, and conduct further testing to evaluate their consistency.\\
In this way, two interesting trends have been identified - at least one of them immediately useful to the potential users of the instrument. \\
\section{Mass Flow Rate Trend}
First, the measurement accuracy of the instrument of both mass flow rate and density improves as the flow rate is reduced. For the lowest flow rates: 20 and 30 gs$^-1$, the mass flow measurement error magnitude falls within 25\%, and within 10\% at 20 gs$^-1$. As for density measurement at low flow rates, the instrument's performance is potentially practical for its intended use of estimating vapour quality. At 20 gs$^-1$, the vapour quality measurement error (using the measured density and reference flow rate)  decays to less than 10\% for vapour qualities greater than 28\%. While the error reaches 40\% for low vapour qualities, it is at high vapour qualities, close to dry-out, that accuracy is valued. The fact that the instrument's accuracy improves to 10\% towards the dry side of the vapour means it may perform well enough to be of interest to CERN.\\
\\
This mass flow trend exhibits a secondary coherent phenomenon. At -10$^\circ$ temperature set point with sufficient flow rates, the non-linear mass flow error peaked as a function of vapour quality, with the peaks tending dryward with decreasing flow rate, as shown in Figure \ref{plot:3}. \\
Given the literature on coriolis flow meter performance in 2-phase, a tempting explanation was the occurence of a flow pattern transition at this point. To test this, the flow conditions at each of the peak mass flow errors in were calculated and displayed in Table \ref{tab:flowConditions}, and their corresponding vapour quality and mass flux were evaluated on a Cheng flow pattern map \cite{Cheng 2008}. This revealed that the mass flow error peaks occur at a vapour quality in the order of 10 percentage points greater than the flow pattern transition between intermittent and annular flow predicted by Cheng \cite{Cheng 2008}. In addition, this theory would not explain the dry-ward tendency of the vapour quality at peak mass flow errors with decreasing flow rate.\\
In response, a second theory for the mass flow trend was explored: the role of vapour phase velocity. Using a MATLAB function calling REFPROP, vapour phase velocities were calculated for the flow conditions at each peak mass flow error and tabulated in Table \ref{tab:flowConditions}. The flow velocities for the peak mass flow rates formed a tight group with mean = 3.44 ms$^{-1}$, $\sigma$ = .245 ms$^{-1}$ and maximum deviation = 0.277 ms$^{-1}$ or 7.5\%. Given the inexact location of the data points used to approximate the true peaks, this was interpreted as strong evidence that the mass flow error behaviour was due to vapour phase velocity. \\
As shown in Figure \ref{gasVelocity}, the vapour phase velocity accelerates with nominal mass flow rate at a given vapour quality, which could explain the increasing magnitude of the mean value of flow errors. But crucially, the group of vapour phase velocities indicate that the errors peak at a critical velocity, and decay with further acceleration. Since mass flow rate and vapour quality are first order factors of VPV, the VPV reaches critical velocity at a higher vapour quality for a lower mass flow rate. (Recall equation 2.3). This would also explain why the lower nominal mass flow rates do not exhibit a peak error - their VPVs never reach the critical value. As shown in Figure \ref{gasVelocity}, the lower mass flow rates fail to accelerate the vapour to critical VPV.
\section{Temperature Trend}
%reduced pressure
The second trend identified in the flow meter's performance was an improvement in measurement accuracy of both mass flow and density with increasing coolant temperature. The trend is visible in figures \ref{plot:5}, \ref{plot:6}, \ref{plot:7} and \ref{plot:8}, which show errors at constant nominal flow rate for various coolant temperatures. \\
The improvement in temperature cannot readily be explained by the theory, but it is speculated that \textit{reduced pressure} plays a role. As discussed in Chapter \ref{litReview}, the reduced pressure decreases with decreasing coolant temperature, making predictions of evaporative behaviour more difficult. This phenomenon could be impacting the accuracy of the flow meter's mass flow performance. In the case of density, it could be affecting the sensor, the theoretical model used to calculate reference conditions, or both.
\section{Uncertainty}
The experimental method exhibited sufficient accuracy to deliver clear, repeatable results over a wide range of test conditions. However, the nature of the apparatus limited the relevance of the findings to a prelimenary overview of the instrument's performance. A direct specification of the error bars on the findings is impractical due to the many layers of filtering and analysis, and the assumptions inherent in the physical methodology. TIF is not a laboratory test bench, but a large, operational cooling system. There were significant limitations on the apparatus:
\begin{itemize}
\item{The chiller that cools the accumulator and condenser requires a heat load of at least 3 kW on the system to function effectively, depending on the temperature set point. This makes testing at low flow rates and temperatures at the edges of the plant's envelope difficult. Low flow rates require very low heat loads for a broad range of vapour quality without dry out. And due to environmental heat leak, low temperatures tend to overload the chiller while high ones cause it to overheat.}
\item{The inlet pressure at the instrument is a crucial parameter affecting the calculation of reference vapour quality and density. However, the sensor inlet lacks instrumentation. Instead, the pressure in the sensor is assumed to equal the saturation pressure of the temperature measured inside the sensor [TT7424]. Since the flow is 2-phase, it is fair to assume that the saturation pressure is equal to the local pressure. However, a pressure-drop on the inlet side of the instrument would result in an underestimate of true inlet pressure. Krohne specifies a liquid pressure drop in the order of mbar, even at a high flow rates. But there is no data on 2-phase pressure drop, which the literature shows is far higher.\cite{Mastrullo 2010}}
\end{itemize}
In addition, some of the assumptions defined in Chapter \ref{analysis} contribute significant uncertainties. The impact of each one is summarised below:
\begin{enumerate}
\item{Pure liquid at manifold inlet: the assumption that the fluid is always sub-cooled at the manifold inlet comes from the high degree (10-40$^\circ$C) of sub-cooling at the inlet of the pump. The assumption is guaranteed for steady state data by the MATLAB functions discussed in Chapter \ref{analysis}. These would throw an error if they detected two-phase flow when evaluating liquid enthalpy based on pressure and temperature.}
\item{Adiabatic apparatus: Heat pick-up can indeed be assumed to be negligible, given the complete insulation of the apparatus, and the relatively high heater powers being examined.}
\item{All heater power is an input to the coolant: Given that all the analysed data is steady-state, it is safe to assume that all heating apparatus is in thermal equilibrium, and that all power is therefore entering the flow. Environmental heat leak is negligible, given assumption 2.}
\item{Heaters deliver correct power: The heater's open loop control has been validated before, but there is no way to know for certain if they delivered the requested power. This would require measuring the true RMS current in the coils.}
\item{Accumulator temperature constant: The slow response of the accumulator PID controller led to temperature fluctuations in the order of 0.5$^\circ$C, implying a relative vapour quality error of about 5\% depending on the set point and vapour quality.}
\item{Instrument inlet geometry: While the mounting of the instrument was approved by Krohne, a more robust position with a straight inlet pipe would ensure the absence of a swirl and turbulence, leading to more reliable data.}
\item{Constant nominal flow rate: The nominal flow rate was set at the beginning of each test. In fact, this flow rate varied with the changing pressure drop due to vapour quality. This resulted in variations of nominal flow rate in the order of 5 gs$^-1$. Since all error calculations employed the real-time reference flow rate (FT3020), this only affected the nominal test conditions linking points on the plots.}
\end{enumerate}
The collective effect of these uncertainties is a study that characterises the overall performance of the Optimass instrument, and demonstrates under which conditions it performs best. While the errors measured are repeatable, the nature of the apparatus means that they are not a reliable measure of the sensor's accuracy under laboratory conditions. As a result, this study is largely a stepping tone: showing the viability of the approach to vapour quality measurement, the conditions underwhich this particular instrument's performance is satisfactory, and areas for futher research.
\chapter{Conclusions}
This study has validated the concept of determining vapour quality from 2-phase density, and has broadly characterised the performance of the Optimass 6400 for this purpose. The data evaluated mass flow and density measurement accuracy, and its ultimate effect on vapour quality measurment, at different vapor qualities for a range of coolant temperatures between -25 and +5 $^\circ$C and nominal flow rates between 20 and 105 gs$^{-1}$. The overall performance of the instrument was, while repeatable, demonstrably unpredictable and far from satisfactory at high flow rates and low temperatures. Measurement errors up to 100\% were observed at high nominal flow rates. At low flow rates, however, mass flow and density error fell within 25\%, giving vapour quality estimation errors in the order of 10\% under certain test conditions - accurate enough to be of interest to CERN.\\
Besides performance improving at lower nominal flow rates, the data also demonstrated a series of peaks in the absolute value of mass flow error, which move dry-ward as the flow rate is lowered. Evaluating the flow conditions at these points showed that they are most likely the result of the vapor phase velocity reaching a critical value of about 3.44 ms$^-1$, SD=0.245ms$^-1$, maximum deviation < 7.5\%. This was further confirmed by the fact that mass flow errors at lower flow rates, whose vapour phase velocities never reach this critical value, do not exhibit a peak error. Vapour phase velocity is known to be a critical parameter in dimensioning coriolis flow meters. If the excessive vapour phase velocity is the cause of the larger flow rate errors, this would indicate that the instrument is undersized for its application.\\
Finally, flow meter performance appeared to improve with coolant temperature. No immediate explanation for this trend was found, but it is speculated that \textit{reduced pressure} plays a role. Research of this parameter - the ratio of the cooling cycle's operating pressure to its critical pressure, is in its infancy. But so far it has demonstrated that the physics of boiling is unpredictable at low reduced pressures, which could explain the greater flow and density errors at these pressures - they could be due to errors in the reference conditions or in the measurements themselves.\\
Overall, this study has provided an overview of the performance of the Optimass 6400, and has served to identify areas for further research. These are discussed below.
\chapter{Future Work} \label{further research}
The promising performance of the Optimass 6400 at low flow rates makes this a clear target for further research. While the present apparatus made flow rates below 20gs$^{-1}$ unsustainabale, an expected modification to the apparatus in May 2015 will allow a broader range of all test parameters to be explored. Indeed, testing of the Optimass instrument is expected to continue at CERN. Future tests should consider the following recommendations:
\begin{itemize}
\item{Install instrumentation at the sensor inlet to measure the true pressure, giving more accurate calculation of true and reference conditions, and allowing the measurement of pressure drop across the instrument - a crucial parameter at this location in a cooling system.}
\item{Modify the flow meter's position to connect a straight section of pipe to its inlet, allowing time for any turbulence to settle.}
\item{Validate the heater control system by measuring true RMS current and comparing it to demand signals.}
\item{Consider implementing a closed loop control system for the pump speed to regulate the nominal mass flow rate given a dynamic system characteristic.}
\item{Collect further data to assess the repeatability of the mass flow and temeprature trends identified above over a range of test conditions.}
\item{Consider sourcing and testing a larger instrument, to confirm the role of vapour phase velocities in measurement errors.}
\item{Take into account any new research on \textit{reduced pressure} in analysing the instrument's performance.}
\end{itemize}
Finally, any future assessment of the Optimass 6400's practicality for a real-time measurement of vapour quality would have to evaluate its transient response. Time domain analysis is beyond the scope of tihs report, but would in itself have to be examined to prove the viability of the concept.

\begin{thebibliography}{9}

\bibitem{Mastrullo 2012}
R. Mastrullo et al. "CO$_2$ and R410A: two-phase flow visualizations and flow boiling measurements at medium (0.50) reduced pressure." \textit{Applied Thermal Engineering} 49. 2012. pp. 2-8.

\bibitem{Mastrullo 2012b}
R. Mastrullo et al. "Flow pattern maps for convective boiling of CO 2 and R410A in a horizontal smooth tube: experiments and new correlations analyzing the effect of the reduced pressure." \textit{International Journal of Heat and Mass Transfer} vol. 55.5. 2012. pp. 1519-1528.

\bibitem{O'Banion 2013}
Tom O'Banion,  "Coriolis: the direct approach to mass flow measurement." \textit{Chemical Engineering Progress} 109.3 2013, pp. 41-46.

\bibitem{REFPROP}
REFPROP. NIST REfrigerant Propertiex Database 23, Gaithersburg, MD, 1998, Version 6.01.

\bibitem{Wu 2011}
J. Wu et al. "Investigation of heat transfer and pressure drop of CO 2 two-phase flow in a horizontal minichannel." \textit{International Journal of Heat and Mass Transfer} 54.9 2011. pp. 2154-2162.

\bibitem{Mastrullo 2010}
R. Mastrullo, A.W. Mauro, A. Rosato, G.P. Vanoli. "Carbon dioxide heat transfer coefficients and pressure drops during flow boiling: Assessment of predictive methods." \textit{International Journal of Refrigeration} 2010, vol. 33, pp. 1068-1085

\bibitem{Mastrullo 2009c}
R. Mastrullo et al. "Comparison of R744 and R134a heat transfer coefficients during flow boiling in a horizontal circular smooth tube." \textit{International Conference on Renewable Energies and Power Quality (ICREPQ09)}, Valencia, Spain, April 15-17. 2009.

\bibitem{Yun 2005}
Yun et al. "Flow boiling heat transfer of carbon dioxide in horizontal mini tubes." \textit{International Journal of Heat and Fluid Flow} 26.5 2005. pp. 801-809.

\bibitem{ISO}
International Organization for Standardization. "ISO 10790:2015(E) Measurement of fluid in closed conduits - Guidance to the selection, installation and use of Coriolis flowmeters (mass flow, density and volume flow measurements)." 2015

\bibitem{Mastrullo 2009a}
R. R. Mastrullo, A.W. Mauro, A. Rosato, G.P. Vanoli. "Carbon dioxide local heat transfer coefficients during flow boiling in a horizontal circular smooth tube." \textit{International Journal of Heat and Mass Transfer} 2009, vol. 52, pp. 4184-4194

\bibitem{TIF PoS}
P. Tropea \textit{et al.} "Design, construction and commissioning of a 15 kW CO$_2$ evaporative cooling system for particle physics detectors: lessons learnt and perspectives for further development" \textit{Proceedings of Science}, 2014, Paper no. 223

\bibitem{jerome} 
J. Daguin \textit{et al.} "Evaporative $CO_2$ Cooling System for the Upgrade of the CMS Pixel Detector at CERN", \textit{10th IIR Gustav Lorentzen Conference on Natural Refrigerants}, 2012, Paper no. 188.

\bibitem{krohne online}
Krohne Group. "Optimass 6400" Internet: \underline{http://optimass6400.krohne.com/\#\_introduction}, [Feb. 18, 2015]

\bibitem{krohne brochure}
Krohne Group. "Optimass 6400." Brochure. Apr 2013

\bibitem{Cheng 2008}
L. Cheng, G. Ribatski, J. M. Quib$\acute{e}$n, J R. Thome. "New prediction methods for CO$_2$ evaporation inside tubes: Part I - A two-phase flow pattern map and a flow pattern based phenomenological model for two-phase flow frictional pressure drops." \textit{International Journal of Heat and Mass Transfer} vol. 51, pp. 111-124, 2008

\bibitem{bart}
B. Verlaat. "Controlling a 2-phase CO2 loop using a 2-phase accumulator." \textit{International Conference of Refrigeration}, 2007, Beijing, China, ICR07-B2-1565 

\bibitem{bart2}
A.P. Colijn, B. Verlaat. "Evaporative CO$_2$ Heat Transfer Measurements for Cooling Systems of Partical Physics Detectors." \textit{7$^{
th}$ International Conference on Heat Transfer, Fluid Mechanics and Thermodynamics}, 2010, Antalaya, Turkey, HEFAT2010 

\bibitem{mishra}
B. Mishra. "CO$_2$ based two phase cooling test set up for CMS trackers: Comparison of experiments with theoretical models." \textit{CERN CMS Collaboration}

\bibitem{CO2 PoS}
B. Verlaat. "CO2 Cooling Developments for HEP Detectors." \textit{Proceedings of Science}, 2009

\bibitem{emerson youtube}
Emerson Electric Co. Video File: "Demonstration: Coriolis Flowmeter excels with Two-Phase Flow (entrained gas)." Retrieved from \underline{https://www.youtube.com/watch?v=AjtdNxDOeoo}, Jan. 17, 2013, [Mar. 15, 2015]

\bibitem{tif web}
P. Tropea. "The CMS PIX Phase I upgrade CO2 cooling: a full scale prototype ready for tests." Internet: \underline{http://ph-news.web.cern.ch/content/cms-pix-phase-i-upgrade-co2-cooling-full-scale-prototype-ready-tests}, Dec. 13, 2013 [Mar. 14, 2015] 

\bibitem{coriolisPrinciple}
Omega Engineering Inc. "Liquid Flowmeters." Internet: \underline{http://www.omega.com/techref/flowcontrol.html}, [May 2nd, 2015]

\bibitem{emerson EGM}
D. Wehrs, A. Klosinski. "Entrained Gas Diagnostic with Intelligent Differential Pressure Transmitter." White Paper: \textit{Emerson Process Management}, Jan. 2008, p. 1

\bibitem{processArticle}
K. Parker. "Bent-tube Coriolis flowmeter slated for entrained gas, high-temp applications." \textit{Processing Magazine} (Jul. 1, 2013)

\bibitem{CERN courier}
B. Verlaat, "CO2 cooling is getting hot in high-energy physics." \textit{CERN Courier} (May 31, 2012)

\bibitem{Augyrond 2001}
L. Augyrond \textit{et al.} "Void Fraction Measurement in Two-Phse Helium Flow with Electron Energy Attenuation Detector." \textit{Cryogenic Engineering Conference}, Jul. 2001, Madison, WI, USA C-09B-02

\bibitem{MIT}
Jacopo Buongiorno. "NOTES ON TWOPHASE FLOW, BOILING HEAT TRANSFER, AND BOILING CRISES
IN PWRs AND BWRs." \textit{MIT OpenCourseWare.} Fall 2010.

\bibitem{Zhao 2013}
Y. Zhao, Q. Bi, R. Hu. "Recognition and measurement in theflow pattern and void fraction of gas-liquid two-phase flow in vertical upward pipes using the gamma densitometer." Applied Thermal Engineering 60 (2013) 398e41

\bibitem{Bauer 2012}
D. Bauer, H. Chaves, and C. Arcoumanis. "Measurements of void fraction distribution in cavitating pipe flow
using x-ray CT." Measurement Science and Technology, Issue 23, 2012

\bibitem{Beker 2005}
M. Beker. "Capacitive measurement technique for void fraction measurements in two phase pipe flow." BSc Project, Delft University of Science and Technology, Delft, the Netherlands, Jul. 2005

\bibitem{lecture}
J. M. Doster, "Flow Regime Mapping, Void-Quality Relations and Pressure Drop in Two Phase Flow." Lecture Notes. Nuclear Engineering Department, North Carolina State University 

\bibitem{Jean 2007}
B. R. Jean. "A Microwave Sensor for Steam Quality." IEEE Transaction on Instrumentation and Measurement, Aug. 2007

\bibitem{Dorfman 2006}
A. Dorfman, E. Fridman. "Vapor quality measurement by a discharging calorimeter." Fluid Phase Equilibria, 244 (2006) 4651

\bibitem{emerson2Phase}
Emerson Process Management. "Explaining how two-phase flow affects mass flowmeters." \textit{Micro Motion, Inc.} 2004

\end{thebibliography}
\appendix
\addcontentsline{toc}{chapter}{Appendices} 
\addtocontents{toc}{\protect\setcounter{tocdepth}{0}}
\singlespacing
\chapter{The TIF Cooling System}\label{app:TIF}
\includepdf{../docs/PI_TIF_Plant.pdf}
\includepdf[landscape]{../docs/PI_TIF_Manifold.pdf}
%\chapter{Krohne Calibration and Sizing Documents}
%\includepdf{../docs/calibration.pdf}
%\includepdf{../docs/sizing.pdf}

\chapter{Dummy Load Heater Module Mechanical Design} \label{app:DummyLoad}
\includepdf[landscape]{../docs/Heater_Design.pdf}
\includepdf[landscape]{../docs/heater2.pdf}
\includepdf[landscape]{../docs/heater3.pdf}
\chapter{MATLAB Code} \label{app:Matlab}
%The complete architecture for the data import, filtering, analysis and visualisation involved several hundred lines of code spread across 6 main scripts and more than dozens of analysis functions. The code was spread across directories for thermodynamics, data filtering and database management. Key functions and scripts will be given here. The rest of the code, as well as raw data and READMEs, can be found at www.github.com/TymP/OptimassMATLAB.\\\
%All data and code are freely accessible, and CERN does not claim any intellectual property.
\section{Thermodynamics}
\begin{verbatim}
function [D, Q] = findReturnDandQ2(P3, T3, power1, power2, flow, T5)
%%%[Density [kg/m^3],Quality] = findDensity(Pressure3 [bar], Temperature 3 [C], Power 1 [W], Power 2 [W], flow [g/s], local temperature [C])
%%%Calculates the density of the two phase fluid on the return line using
%%%the manifold supply conditions, heater power, reference (liquid) flow
%%%rate and local temperature in the instrument. Temperature is used to
%%%calculate local pressure in 2-phase.
%Tym Pakulski April 2015
%Convert to refprop units
cd('../optimass')
P3=P3*100; %kPa
T5=T5+273;%kpa
T3=T3+273; %K
flow=flow/1000;

cd('../REFPROP')
%Calculate local pressure at instrument: the saturation P at T5
P5=refpropm('P','T',T5,'Q',0.5,'CO2');

%Calculate enthalpy before expansion valve on manifold loop.
h3=refpropm('H','T',T3,'P',P3,'CO2');

%Calculate change in enthalpy during evaporation.
dh=(power1+power2)/flow;

%calculate new enthalpy on return line.
h5=h3+dh;

%Determine density
D=refpropm('D','P',P5,'H',h5,'CO2');

%Determine Phase
Q=refpropm('Q','P',P5,'H',h5,'CO2');
cd('../optimass')
end

function [Psat] = findPsat(Tsat)
%[Psat [bar]] = findPsat(Tsat [C])
%   Returns the saturation pressure for a given temperature of 2-phase CO2

%REFPROP Unit conversions
Tsat=273+Tsat;%K

%Navigate to REFPROP directory
cd ..
cd REFPROP

Psat=refpropm('P','T',Tsat,'Q',0.5,'CO2'); %kpa

%Convert to practical units.
Psat=Psat/100;%bar

%navigate home
cd ..
cd Optimass
end

function [ gasVelocity ] = findGasVelocity(massFlow,VQ,Temp,CSA)
%%%[flowVelocity [m/s]]=findFlowVelocity(volumetric Flow rate [m^3/s],
%%%cross-sectional area [m^2])
%   Returns the volumetric flow rate of the gas phase in a saturated fluid.
%   
volumetricFlowRate=findGasVolumetricFlow(massFlow,VQ,Temp);
gasVelocity=volumetricFlowRate/CSA;

end

function [ volumetricFlow ] = findGasVolumetricFlow(massFlow,VQ,Temp)
%%%[gas volumetric flow rate [m^3/s]]=findGasVolumetricFlow(massFlowRate[g/s],vapour quality
%%%[decimal], saturation temperature [C])
%   Returns the volumetric flow rate of the gas phase in a saturated fluid.
%   
%REFPROP Units
massFlow=massFlow/1000;
Temp=Temp+273;

cd ..
cd REFPROP
gasDensity = refpropm('-','T',Temp,'Q',VQ,'CO2');
cd ..
cd Optimass

volumetricFlow=massFlow*VQ/gasDensity; %m^3/s

end

\end{verbatim}
\section{Data Handling}
\begin{verbatim}
%SCRIPT createTimeFilter3*************************************************
%Tym Pakulski April 2015
%Imports steady state timestamps and implements a foreword scanning
%algorithm to identify steady-state intervals. averaging the data across
%these intervals to return a single state vector for each desired time
%step.
%Import the steady-state timestamps.
importTimestamps;
%Merge time and date into a single float value.
ssStamps=ssDates+ssTimes;

%USER INPUT
%Define the maximum allowable time interval in forward averaging, to
%override the steady-state idntification algorithm.
maxTimeInterval=30;%seconds
%convert to Matlab hours.
maxTimeIntervalInDays=maxTimeInterval/86400;%86400 seconds per day
%Define allowable noise level for data  to be considered steady state
allowableNoise=.01; %1%
%Define number of points to be grabbed at a time and averaged to assess
%stability.
forwardHandful=3;%points
%Define a matrix with all raw data signals.
allData=[FT3020.PosSt,EHDL1.PosSt,EHDL2.PosSt,PT7024.PosSt,TT7024.PosSt,PT7450.PosSt,FT7524.PosSt,DT7424.PosSt,TT7424.PosSt,PT7056.PosSt,TT7056.PosSt];
%Change directory for our data analysis functions.
cd analysisFunctions
%Define a vector that will hold the indeces of all the steady state
%timestamps in the raw data.
indexVector=[];
%Populate the index vector by comparing ss-timestamps to time data in
%database.
for i=1:length(ssStamps)
   indexVector(end+1)=findClosestValue(Time.Day,ssStamps(i));
end
%The reach vector exists parallel to the index vector, each index housing
%the last steady state value going forward in time from the steady-state
%timestamp.
reachVector=[];
%Populate Reach Vector.
for i=1:length(indexVector)
    reachVector(i)=findClosestValue(Time.Day,(ssStamps(i)+maxTimeIntervalInDays));
end
%Data to filter for steady state conditions: reference flow rate, optimass
%flow rate, heat load, density.
dataToFilter=[FT3020.PosSt,FT7524.PosSt,EHDL1.PosSt.*EHDL2.PosSt,DT7424.PosSt];
%override reach vector values with steady state values.
for i=1:length(reachVector)
    dataSubSet=dataToFilter(indexVector(i):reachVector(i));
    reachVector(i)=indexVector(i)+findSteadyStateSpan(dataSubSet,allowableNoise,forwardHandful,(reachVector(i)-indexVector(i)));
end
[rows, columns]=size(allData);
%create empty matrix with dimension of number of columns and ss timestamp
%rows.
cleanUnlabeled=zeros(length(indexVector),columns);
for column=1:columns %iterate through each column of cleanUnlabeled
    for row=1:length(indexVector) %iterate through each row.
        handFull=[indexVector(row):1:reachVector(row)];
        cleanUnlabeled(row,column)=mean(allData(handFull,column));
    end
end
%Define new steady-state data vectors
FT3020.Clean=cleanUnlabeled(:,1);
EHDL1.Clean=cleanUnlabeled(:,2);
EHDL2.Clean=cleanUnlabeled(:,3);
PT7024.Clean=cleanUnlabeled(:,4);
TT7024.Clean=cleanUnlabeled(:,5);
PT7450.Clean=cleanUnlabeled(:,6);
FT7524.Clean=cleanUnlabeled(:,7);
DT7424.Clean=cleanUnlabeled(:,8);
TT7424.Clean=cleanUnlabeled(:,9);
PT7056.Clean=cleanUnlabeled(:,10);
TT7056.Clean=cleanUnlabeled(:,11);

%collect steady state signals in a single matrix.
cleanData=[Test,Flow,Temp,FT3020.Clean,EHDL1.Clean,EHDL2.Clean,PT7024.Clean,TT7024.Clean,PT7450.Clean,FT7524.Clean,DT7424.Clean,TT7424.Clean,PT7056.Clean,TT7056.Clean];
cd ..

%SCRIPT processData ************************************************************
%Tym Pakulski April 2015
%processes steady-state date to calculate error signals and thermodynamic
%properties of interest.
%processData
%Calculated signals
%Flow error calculation.
absFlowError=FT7524.Clean-FT3020.Clean;
relFlowError=absFlowError./FT3020.Clean;
%Calculating from REFPROP
cd analysisFunctions
cd thermodynamics
cd optimass
expectedDensity=[];
VQ=[];
for i=1:length(PT7450.Clean)
    i
    [expectedDensity(end+1),VQ(end+1)] = findReturnDandQ2(PT7024.Clean(i),TT7024.Clean(i),EHDL1.Clean(i),EHDL2.Clean(i),FT3020.Clean(i),TT7424.Clean(i));
end
%Transpose property vectors
expectedDensity=expectedDensity';
VQ=VQ';
%calculate error signals
absDensityError=DT7424.Clean-expectedDensity;
relDensityError=absDensityError./expectedDensity;
measuredVelocity=[];
predictedVelocity=[];
sensorFlowVelocity=[];
%calculate aggregate flow velociteis
for i=1:length(PT7450.Clean)
    measuredVelocity(end+1) = calculateFlowVelocity(FT3020.Clean(i),DT7424.Clean(i),8);
    predictedVelocity(end+1)=calculateFlowVelocity(FT3020.Clean(i),expectedDensity(i),8);
    sensorFlowVelocity(end+1)=calculateFlowVelocity(FT7524.Clean(i),DT7424.Clean(i),8);
end
measuredVelocity=measuredVelocity';
predictedVelocity=predictedVelocity';
sensorFlowVelocity=sensorFlowVelocity';
%navigate to REFPROP directory
cd ..
cd REFPROP
%Calculate Optimass VQ signals
optimassVQ=[];
for i=1:length(VQ)
    optimassVQ(end+1)=refpropm('Q','T',(273+TT7424.Clean(i)),'D',DT7424.Clean(i),'CO2');
end
optimassVQ=optimassVQ'
absVQerror=optimassVQ-VQ;
relVQerror=absVQerror./VQ;
cd ../Optimass
%Calculate gas phase velocities
gasVolumetricFlow=zeros(length(VQ),1);
gasVelocity=zeros(length(VQ),1);
for i=1:length(VQ)
    if VQ(i)>0.001 && VQ(i)<1
        %Calculate gas velocity
        gasVelocity(i)=findGasVelocity(FT3020.Clean(i),VQ(i),TT7424.Clean(i),1.0053e-04);
    end        
end
%collect data in a single output matrix for saving
processedData=[cleanData,absFlowError,relFlowError,expectedDensity,VQ,absDensityError,relDensityError,measuredVelocity,predictedVelocity,sensorFlowVelocity,optimassVQ,absVQerror,relVQerror,gasVelocity];
%save the new database
cd ..
cd ..
cd ..
mkdir('postProcessedData');
cd postProcessedData
fileName=num2str(datenum(datestr(clock,0)));
mkdir(fileName);
cd(fileName)
save processedData
cd ..
cd ..
\end{verbatim}
\section{Data Visualisation}
\begin{verbatim}
%SCRIPT - generatePlots******************************************************
%%%Calls the make plot function with the user-specified test conditions to
%%%generate a series of plots. These are then saved to the '/plots'
%%%directory as .png files.
importTestLog;
%OVERVIEW Plots
%Mass Errors
%Define variables to plot.
variable1='Vapour Quality';
variable2='Relative Flow Error';
%Create elements of legend vector.
colorVec={'b','g','r','c','m','k','y'};
markerVec={'o','x','s','+','*','<','p','h','V'};
%Define test conditions of interest.
tempVec=[-25,-20,-10,-5,0,5,10];
flowVec=[20,30,40,50,60,70,80,90,105];
legendText={};
makePlot;
title([variable2, ' against ', variable1, ' at various Temperatures and Flow Rates.'],'FontSize',18);
%Change directory to export functions.
cd figureExport
%Maximise figure window
set(gcf,'units','normalized','outerposition',[0 0 1 1])
%Export figure to 'plots' directory.
export_fig ../plots/fig1.png
cd ..

%Repeat the proces for each figure.
%Density Errors************
variable1='Vapour Quality';
variable2='Relative Density Error';
legendText={};
makePlot;
title([variable2, ' against ', variable1, ' at various Temperatures and Flow Rates.'],'FontSize',18);
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig2.png
cd ..

%Series 2: Performance at -10 for various flow rates*****
%create combined markervec
colorMarkVec={'ro','go','bo','rx','gx','bx','r>','g>','b>'};
variable1='Vapour Quality';
variable2='Relative Flow Error';
colorVec={'b','g','r','c','m','k','y'};
markerVec={'o','x','s','+','*','<','p','h','V'};
tempVec=[-10];
flowVec=[20,30,40,50,60,70,80,90,105];
legendText={};
makePlot2;
title([variable2, ' against ', variable1, ' at -10 C, various Flow Rates.'],'FontSize',18);
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig3.png
cd ..

%Density Errors************
variable2='Relative Density Error';
legendText={};
makePlot2;
title([variable2, ' against ', variable1, ' at -10 C, various Flow Rates.'],'FontSize',18);
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig4.png
cd ..

%GAS VELOCITY
variable2='Gas Velocity'
legendText={};
makePlot2;
title(['Vapour Phase Velocity against ', variable1, ' at -10 C, various Flow Rates.'],'FontSize',18);
ylabel('Vapour Phase Velocity [m/s]','FontSize',18)
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig12.png
cd ..

%Series 3: 70 g/s, various Temperatures
flowVec=[70];
tempVec=[-25,-20,-10,-5,0,5,10];
%Flow error against vq
variable2='Relative Flow Error';
legendText={};
makePlot3;
title([variable2, ' against ', variable1, ' at ', num2str(flowVec(1)),' g/s, various Temperatures'],'FontSize',18);
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig5.png
cd ..

%Density error against vq for various temperatures
variable2='Relative Density Error';
legendText={};
makePlot3;
title([variable2, ' against ', variable1, ' at ', num2str(flowVec(1)),' g/s, various Temperatures'],'FontSize',18);
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig6.png
cd ..

%series 4: same thing at 30 g/s, various temperatures
flowVec=[30];
tempVec=[-25,-20,-10,-5,0,5];
%Flow error against vq
variable2='Relative Flow Error';
legendText={};
makePlot3;
title([variable2, ' against ', variable1, ' at ', num2str(flowVec(1)),' g/s, various Temperatures'],'FontSize',18);
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig7.png
cd ..

%Density error against vq
variable2='Relative Density Error';
legendText={};
makePlot3;
title([variable2, ' against ', variable1, ' at ', num2str(flowVec(1)),' g/s, various Temperatures'],'FontSize',18);
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig8.png
cd ..

%again for VQ error
variable2='Relative Vapour Quality Error';
legendText={};
makePlot3;
title([variable2, ' against ', variable1, ' at ', num2str(flowVec(1)),' g/s, various Temperatures'],'FontSize',18);
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig9.png
cd ..

%VQ error at 20g/s, -10
flowVec=[20];
tempVec=[-10];
legendText={};
makePlot3;
title([variable2, ' against ', variable1, ' at ', num2str(flowVec(1)),'g/s, ', num2str(tempVec(1)),' C'],'FontSize',18);
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig10.png
cd ..

%REPEATABILITY PLOTS 
figure;
%70 g/s, -10 C
testnums=[182,61,50,20];
color={'r','b','g','m'};
variable1='Vapour Quality';
variable2='Relative Flow Error';
for i=1:length(testnums)
    marker=strcat(color{i},'o');
    [var1,var2]=createSubSet(processedData,testnums(i),variable1,variable2);
    plot(var1,var2,marker)
    hold on
end
hold on
variable2='Relative Density Error'
for i=1:length(testnums)
    marker=strcat(color{i},'s');
    [var1,var2]=createSubSet(processedData,testnums(i),variable1,variable2);
    plot(var1,var2,marker)
    hold on
end
legend('Test 1 Flow Error','Test 2 Flow Error','Test 3 Flow Error','Test 4 Flow Error','Test 1 Density Error','Test 2 Density Error','Test 3 Density Error','Test 4 Density Error')
xlabel(variable1,'FontSize',16)
ylabel('Relative Error','FontSize',16)
title('Mass and Density Error repeatability at 70 g/s, -10 C', 'FontSize',18);
cd figureExport
set(gcf,'units','normalized','outerposition',[0 0 1 1])
export_fig ../plots/fig11.png
cd ..



%SCRIPT makeplot script****************************************************************************
%%%generates a plot given the user-specified variables and test conditions
%%%of interest in the generatePlots script. calls the findTestNums funciton
%%%to define a cell array of test vectors with conditions of interest.
figure;
for i=1:length(tempVec)
    color=colorVec{i};
    for j=1:length(flowVec)
        marker=markerVec{j};
        testnums=findTestNums(Test,Temp,Flow,tempVec(i),flowVec(j));
        %Retrieve data of interest from steady-state database
        %(processedData)
        [var1,var2]=createSubSet(processedData,testnums,variable1,variable2);
        mark=strcat(color,marker);
        plot(var1,var2,mark);
        hold on
        if length(testnums)>=1
            legendText{end+1}=[num2str(tempVec(i)),' C, ', num2str(flowVec(j)),' g/s'];
            
        end
        testnums=[];
    end
end
xlabel(variable1,'FontSize',16)
ylabel(variable2,'FontSize',16)
legend(legendText)
\end{verbatim}

\chapter{Test Log}
\includegraphics[width=\textwidth]{testLog}
\end{document}
